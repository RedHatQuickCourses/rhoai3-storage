= The Architecture of Data Connectivity
:role: Technical Deep Dive
:audience: Platform Engineers & Architects
:description: A comprehensive guide to RHOAI 3 storage primitives (Connections/Types), protocols (S3/OCI/URI), and persistence layers (RWO/RWX).

[.lead]
*To build a factory that scales, you must master the vocabulary of the floor.*

In the previous module, we established *why* RHOAI decouples data from compute. Now, we will examine *how* the platform executes this. This architecture relies on a specific set of API primitives that act as the "machinery under the floorboards".

As a Platform Engineer, you are managing the lifecycle of data as it transitions from "Cold Object Storage" to "Hot Shared Memory". To do this, you must master three distinct layers: **The Primitives** (API Objects), **The Gateway** (External Data), and **The Workspace** (Internal Storage).



== 1. The Core Primitives (The API Layer)
Before defining *where* data lives, you must understand the Kubernetes resources that represent it. RHOAI 3 introduces specific terminology to standardize configuration.

=== Data Connection (The Instance)
A Kubernetes resource containing configuration parameters (key-value pairs) to access external data.

 * **Storage Location:** Stored securely as a Kubernetes Secret.
 * **Injection:** Injected into Pods as Environment Variables at runtime.
 * **Scope:** Namespace-isolated; it cannot be shared across projects.

=== Connection Types (The Template)
An administrator-defined template that dictates what fields a user must provide.
 * **Example:** An admin creates a "Corporate S3" type requiring `Bucket`, `Endpoint`, and `Region`.
 * **Value:** Ensures standardization across the enterprise.

[WARNING]
.Deprecation Alert
====
The annotation `opendatahub.io/connection-type-ref` is **deprecated**.
You must now use `opendatahub.io/connection-type-protocol` for all new connection secrets.
====

== 2. The Gateway: Supported Protocols (External Storage)
RHOAI does not store massive datasets inside the cluster. Instead, it uses Data Connections as a "Gateway" to external storage. This layer supports three primary protocols.

=== A. S3-Compatible Object Storage (`s3`)
The default protocol for Data Lakes, Pipeline Artifacts, and standard Model Serving.
 * **Required Fields:** Access Key, Secret Key, Endpoint, Bucket.
 * **Lab Context:** We use MinIO to simulate a corporate data lake. The connection injects `AWS_ACCESS_KEY_ID` and `AWS_S3_ENDPOINT` so code using `boto3` works automatically.
 * **Note:** For self-signed certificates (MinIO), you must inject the Bundle CA.

=== B. OCI Model Registry (`oci`)
The "Accelerator" protocol for high-speed model inference.
 * **Use Case:** "Modelcars"â€”pulling models from container registries instead of downloading weights as files.
 * **Performance:** Leverages the node's container cache for massive deduplication, making it optimal for large-scale inference deployments.
 * **Lab Context:** We use the `oci` protocol to mount the Granite model directly from Quay.io.

=== C. URI (`uri`)
The "Surgical Link" for direct HTTP/HTTPS access.
 * **Use Case:** Direct links to specific model versions or files (e.g., `https://.../model-v1.onnx`).
 * **Limitation:** Generally read-only and less secure than S3/OCI connections.
 * **Lab Context:** We use the `uri` protocol to point to a specific versioned folder in a private bucket, bypassing the need to expose the entire bucket root.

== 3. The Workspace: Cluster Storage (Internal Storage)
While Data Connections handle "Inflow/Outflow," **Cluster Storage** handles the "Work in Progress". This is governed by OpenShift Storage Classes and determines your collaboration capabilities.



=== ReadWriteOnce (RWO) - "The Scratchpad"
 * **Architecture:** Block Storage (e.g., AWS EBS `gp3-csi`, vSphere).
 * **Behavior:** Maps 1:1 with a user's Workbench (e.g., `/opt/app-root/src`).
 * **Constraint:** Can only attach to one node at a time. Ideal for personal home directories and databases.

=== ReadWriteMany (RWX) - "The Collaboration Zone"
 * **Architecture:** File Storage (e.g., ODF `ocs-storagecluster-cephfs`, NFS, AWS EFS).
 * **Behavior:** Mounts to multiple nodes simultaneously.
 * **Constraint:** Required for shared team folders and distributed training.
 * **Critical Check:** You *must* verify your cluster supports this, or these PVCs will hang in a `Pending` state.

== 4. The Metadata Layer: The Shift to Databases
[IMPORTANT]
.Critical Architecture Change in RHOAI 3
====
In previous versions, metadata was often stored in SQLite files on PVCs. RHOAI 3 moves production metadata to **Relational and Vector Databases** for scalability.
====

 * **Model Registry:** Now requires an external **MySQL** database (5.x/8.x) to store model lineage and version history, rather than a local file.
 * **Llama Stack (RAG):**
 ** **Vector Store:** Requires **Milvus** or **PostgreSQL (pgvector)**.
 ** **Metadata:** SQLite is removed for production; PostgreSQL is mandated.

== System Requirements Checklist
Before proceeding to the lab automation, ensure your underlying cluster meets these specs:

 * [ ] **Default Storage Class:** Must support dynamic provisioning (e.g., `gp3-csi`).
 * [ ] **Shared Storage Driver:** Must support `ReadWriteMany` (e.g., `ocs-storagecluster-cephfs` or NFS) for team collaboration features.
 * [ ] **Object Storage:** An S3-compatible endpoint (MinIO, AWS, Noobaa) is *mandatory* for Pipelines and Model Serving.

*Now that you understand the blueprint, let's deploy the factory.*